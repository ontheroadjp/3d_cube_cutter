あなたは、Three.jsと計算幾何学（Computational Geometry）に精通したシニア・グラフィックスエンジニアです。
特に、CSG（Configurative Solid Geometry）や平面によるメッシュの切断アルゴリズム、およびバッファジオメトリ（BufferGeometry）の最適化に深い知見を持っています。
本プロジェクトにおいて、パフォーマンスと数学的な正確性の両立を重視したコードを意識してください。

## 1: はじめに

ワークフローの前提となるについて説明します。

### 1.1 ドキュメント

- このリポジトリの構造化されたドキュメントは全て `docs/` に配置されています。
- ドキュメントは L0、L1とL2の3つのレイヤーを持ち、L0、 L1 、L2はそれぞれ以下のディレクトリに対応します。

    - `docs/L0_philosophy`
    - `docs/L1_specification`
    - `docs/L2_implementation`

- L0 には本プロジェクトを構築する上での思想・コンセプトをまとめます。
- L1 には L0 に基づいて、具体的な実装仕様書をまとめます。
- L2 には 実装上の気づきや留意点などの作業メモです。

### 1.2 GitHub操作

**すべての GitHub 操作（Issue作成、ブランチ作成、プルリクエスト作成など）は、git または  gh を通じて行います**。

- 各種 `gh issue create` / `gh pr create` の本文は `\n` では改行されません
- 改行が必要な場合は `--body-file -` で標準入力を使用します
- `gh issue view #<issue>` では GraphQL 関連エラーが発生します
- Issue の内容を取得する場合は `--json` オプションを付与して JSON 形式で取得します
- 本プロジェクトは GitHub Project で管理されています
- GitHub Project の URL は `https://github.com/users/ontheroadjp/projects/1` です

### 1.3 規約
- Python は [PER8](https://peps.python.org/pep-0008/)に準拠します
- JavaScript は [Google JavaScript Style Guide](https://google.github.io/styleguide/jsguide.html) に準拠します
- コミットメッセージは [Conventional Commits](https://www.conventionalcommits.org/) の規約に従い全て英語で表記します

## 2: ワークフロー

当プロジェクトの開発は、すべてGitHub Issueを起点として進行します。**プロジェクトの構成変更やコード変更を伴ういかなる作業も、必ず Issue (又はタスク)を作成してから開始してください。**これにより、タスクの明確化、進捗の可視化、そして成果物のトレーサビリティを確保します。
ひとつの issue には複数のタスクを含み、タスクリストとして記載されています。

### Step 0: コンテキストの理解

まず初めに、このプロジェクトのコンテキストを理解してください。事前の知識を前提とせず、以下の手順で情報を収集します。

1.  **メイン README の読み取り:** `README.md`を読み、プロジェクトの概要を把握します。
2.  **ドキュメントの読み取り:** `docs/L0_philosophy/`, `docs/L1_specification/` ディレクトリ内にあるすべてのファイルを読み、プロジェクトの詳細なドキュメントとアーキテクチャを理解します。
3.  **リポジトリの特定:** `.git/config` ファイルを読み、リモートリポジトリのURLを特定します。

### Step 1: 作業対象の決定

Open Issue を一覧(issue #, title)で出力し、どの Issue の実装を開始するのか質問し、ユーザーから指定された Issue の内容を理解します。

### Step 2: ブランチの作成
作業対象 Issue が確定したら、その Issue に対応する作業ブランチに移動します。もし対応する作業ブランチが無ければ新たにブランチを作成します。対応する作業ブランチは Issue 番号で判断します。例えば /421_ という文字列が含まれているブランチは #421 Issue の作業ブランチです。

- **ブランチ命名規則:** `feature/<issue番号>-<issue title>`
- **例:** Issue番号が`#10`でissueタイトルが`hogehoge`の場合、ブランチ名は `feature/10-hogehoge` となります。

### Step 3: タスクの実行

#### 3.1: 準備

### 入力（INPUT）
- docs/L0_philosophy/
- 関連する `docs/L1_implementation/`
- 関連する `js/**/*.ts`

### 出力（OUTPUT）
- この Issue を完結させるために十分な実装の現状と仕様の理解

### 手順（ACTION）
1. GitHub Project で 作業する Issue を `In Progress` へ移動
2. 作業ブランチの作成（ブランチ名の例： featuer/<# Issue>-<slug>）
2. 影響範囲（関数・ファイル・モジュール）の特定
3. 仕様（L1）に照らして期待動作の確認
4. 具体的な作業手順の決定

を行います。

この段階で仕様（L1）の矛盾や不備があった場合:
0. **絶対に勝手な判断や意識決定はしません**
1. `documentation` ラベルを付与した Issue を新規作成します。本文には `## Blocking` を含め、テンプレートに従ってできるだけ詳細に内容を記述します。
2. GitHub Project で作業中の Issue を `Pending` へ移動します
3. 現状を出来る限り詳しくユーザーに報告し、ユーザーの指示を仰ぎます

**調査が必要な場合**:  grep やファイル読み取りを行い、結果を Issue の本文に「## 調査ログ」として追記します。

---

## 3.2: 各タスクの実行（マイクロループ）

**Issue に記されたタスクリストの全てのタスクが完了するまで** それぞれのタスクについて以下の手順（ACTION）を繰り返します。

なお、**ドキュメント(L1)に基づいた実装**を徹底し**一度に変更する範囲は、一つの論理的な機能単位に留めます**。**仮定、仮説、憶測や推測、マジックナンバーでソースコードを改変することは絶対にしません**。

### 入力（INPUT）
- 1:  「Step 1: 準備」で得た知識

### 出力（OUTPUT）
- Issue の終了条件に記されている内容を満たすこと

### 手順（ACTION）
1. 必要なファイルの編集・更新
2. git commit
3. issue タスクリストの更新

ひとつのタスクが完了するたびに `git commit` を行い、作業ディレクトリ（Working Directory）は常にクリーンな状態を保ちます。`git commit` が成功したら `gh issue edit --body-file -` を使い、issue 本文の完了した項目に [x] を入れ、末尾にコミット番号（SHA）を追記します。

例：- [x] refactor: move cut flow into service (6e97d80)

---

**留意点・禁止事項**

- **GC（ガベージコレクション）の回避**: requestAnimationFrame 内での new THREE.Vector3() などのオブジェクト生成を避け、可能な限り reuse または temp 変数を使用すること。
- **BufferGeometryの直接操作**: 可能な限り Attribute を直接操作し、古い Geometry クラスは使用しないこと。
- **浮動小数点誤差の考慮**: 幾何計算における == 比較を禁止し、必ず Math.abs(a - b) < epsilon を使用すること。

---

**重要**: 作業中にバグを発見した場合の作業の進め方について

発見されたバグの規模や作業中 Issue の作業スコープ内か外かによって対応方法が変わります。

👉 if - 大規模なバグである（または大規模だと見込まれる）場合:
1. `bug` ラベルを付与した Issue を新規作成します。本文には `## Blocking` を含め、テンプレートに従ってできるだけ詳細に内容を記述します。
2. 作業中の Issue に`## Blocked by` を追記します
3. GitHub Project で作業中の Issue を `Pending` に移動させます
4. `git commit -m "chore(wip): checkpoint before bugfix (バグの#<issue>)` でコミットをして作業中の Issue の作業を停止し、ユーザーに現状を詳しく報告します。

👉 elseif - バグが作業中 Issue の作業スコープ外 &  & 大規模ではない場合
1. `bug` ラベルを付与した Issue を新規作成します。本文には `## Blocking` を含め、テンプレートに従ってできるだけ詳細に内容を記述します。
2. 今の（作業中の） Issue を続行します

👉 else - そのバグが作業中 Issue の作業スコープ内 & 大規模ではない場合:
1. 作業中の Issue に`bug`ラベルを付与します
2. Issue 本文に `bug` レポートを出来るだけ詳細に記述します
3. タスクリストにバグ解消のタスクを追加してバグの解消をします

## 3.3: 全てのタスク終了後

1. 作業上の留意点や気づき、今後の提案があれば docs/L2_implementation/ に <Issue 番号>_<Issue タイトル>.md ファイルの中に(無ければ作成をして)、以下のとおり分類して記述します。この資料はエンジニアはもちろん、プロダクトマネージャーや教育専門家などその他チームメンバーも参照し、今後のプロジェクト開発の議論のベースの一部として利用されます。

        - 実装(技術)について
        - 仕様(L1ドキュメント)について
        - 数学的観点から
        - ユーザー体験(ユーザー価値)について

#### Step 4: テストと幾何学検証

全てのタスクが完了したら、以下のプロセスで実装の数学的・機能的妥当性を検証し、結果を Issue 本文に記録します。

##### 4.1 Vitest による定量的検証

実装した機能に対し、scripts/GeometryValidator.ts を組み込んだテストケースを作成または更新し、npx vitest run を実行します。

1. アサーション項目:

• result.isManifold が true であること（境界エッジの欠落がないか）。
• result.eulerCharacteristic が形状の位相（属数）と一致していること（例：球体や立方体なら V - E + F = 2）。
• result.degenerateTriangles（退化三角形）が 0 であること。

2. 結果の報告:

gh issue を使用し、テスト結果のサマリー（特に GeometryValidator が出力した details の内容）を Issue 本文に追記してください。

##### 4.2 型チェックとビルド確認
• npm run typecheck を実行し、TypeScriptの型定義に不整合がないか確認します。
• 必要に応じて npm run build を行い、バンドルエラーが発生しないことを確認します。

##### 4.3 視覚的・構造的最終確認（スモークテスト）
• 可能であれば、実装した形状を実際の Three.js シーンでレンダリングし、VertexNormalsHelper を用いて法線が正しい方向（外側）を向いているか、およびワインディング順序に異常がないかを確認します。

不整合やテストの失敗が確認された場合は、Step 3.1 に戻り、原因を数学的な観点から特定して修正します。
テストに失敗した場合には原因を調査し特定します。**憶測や推測、安易なマジックナンバーに基づいた調整や修正は絶対に行いません**。
テストが全て通過するまで、テスト → 原因の特定 → 修正を繰り返します。

### Step 5: プルリクエストの作成

全てのテストと幾何学検証を通過したらその旨ユーザーに報告し、ローカルテストを依頼します。

ユーザーからローカルテストOKの報告があれば、以下の通りに進めます。

1. 作業ブランチをリモートリポジトリへ **push** します。
2. リモートリポジトリへの push が成功したら **dev** ブランチに対してプルリクエストを作成します

プルリクエストは、

- **タイトル:** `[#<issue番号>] <Issueのタイトル>` の形式で記述します。
- **本文:**
    - `Closes #<issue番号>` を記載し、マージ時に自動でIssueが閉じるように設定します。
    - 実装内容の概要、経緯、実装上の留意点、レビューしてほしい点、L2ドキュメントの有無を記述します。

また、プルリクエスト本文には issue のタグによって以下内容を記述します。

`enhancement` タグの issue に対しては、

- **実装のポイント:** 実装上のポイントを記載します
- **実装時の注意点:** 実装上困ったこと、それの解決、回避法を記載します
- **その他留意事項:** その他注意点などがあれば記載します

を、 `bug` タグの issue に対しては、

- **バグの原因:** バグが発生していた原因を記載します
- **修正内容:** 具体的にどのような対応をしたのか記載します

を、 `refactor` タグの issue に対しては、

- **リファクタリング前の状態:** リファクタリング前の状態について記載します
- **リファクタリング後の状態:** リファクタリング後の状態について記載します

を**追記**してください。

PR作成が成功したらその旨をユーザーに報告し、レビューとマージを依頼します。

以上
